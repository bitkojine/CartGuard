<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#fff7fb" />
    <title>CartGuard Research | Fact-Checked Database</title>
    <meta name="description" content="CartGuard research database with confidence scores, sources, and copy-ready Perplexity prompts." />
    <link rel="icon" href="./assets/favicon.ico?v=3" sizes="any" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png?v=3" />
    <link rel="manifest" href="./site.webmanifest?v=4" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="hero page-hero">
      <nav class="top-nav" aria-label="Primary">
        <a href="./index.html" class="nav-brand">CartGuard</a>
        <div class="nav-links">
          <a href="./beachhead.html">Beachhead</a>
          <a href="./paid-pilots.html">Paid Pilots</a>
          <a href="./research.html" aria-current="page">Research</a>
          <a href="./technical.html">Technical</a>
        </div>
      </nav>
      <p class="eyebrow">Research Database</p>
      <h1>Brutal facts, source links, confidence scores.</h1>
      <p class="lead">Everything we claim should map to these entries. If we cannot source it, we do not say it.</p>
    </header>

    <main>
      <section class="pricing" aria-label="Research standards">
        <h2>Research Standards</h2>
        <ul>
          <li>Primary sources first (EU institutions, regulators, official statistics).</li>
          <li>Each entry must include date, geography, confidence, and source links.</li>
          <li>Modeled estimates must be labeled as modeled.</li>
          <li>Recommendations only. No legal determinations.</li>
        </ul>
      </section>

      <section class="architecture" aria-label="Perplexity prompts">
        <h2>Perplexity Prompt Pack (Copy As-Is)</h2>
        <p class="small-note" id="prompts-updated">Loading prompt pack...</p>
        <div id="prompt-list" class="grid" aria-live="polite"></div>
      </section>

      <section class="architecture" aria-label="Research entries">
        <h2>Research Entries</h2>
        <p class="small-note" id="research-updated">Loading research index...</p>
        <div id="research-list" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <footer>
      <p>CartGuard â€¢ Fact-checked research database</p>
    </footer>

    <script>
      const listEl = document.getElementById('research-list');
      const updatedEl = document.getElementById('research-updated');
      const promptListEl = document.getElementById('prompt-list');
      const promptsUpdatedEl = document.getElementById('prompts-updated');
      const docsById = new Map();

      const badgeClass = (confidence) => {
        const c = String(confidence || '').toLowerCase();
        if (c === 'high') return 'status yes';
        if (c === 'medium') return 'status partial';
        return 'status no';
      };

      const renderEntry = (entry) => {
        const card = document.createElement('article');
        card.className = 'card';
        const geo = (entry.geography || []).join(', ');
        const scope = (entry.industry_scope || []).join(', ');
        const inlineDoc = docsById.get(entry.id) || 'No inline document text found for this entry.';
        const sources = Array.isArray(entry.sources)
          ? entry.sources.map((url) => `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></li>`).join('')
          : '';
        const escapedDoc = String(inlineDoc)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        card.innerHTML = `
          <h3>${entry.title}</h3>
          <p>${entry.summary || ''}</p>
          <div class="pill-row">
            <span class="pill">Status: ${entry.status || 'unknown'}</span>
            <span class="pill">Owner: ${entry.owner || 'n/a'}</span>
            <span class="pill">Created: ${entry.created_at || 'n/a'}</span>
            <span class="pill">Verified: ${entry.last_verified_at || 'n/a'}</span>
            <span class="pill">Sources: ${entry.source_count || 0}</span>
            <span class="pill">Geo: ${geo || 'n/a'}</span>
            <span class="pill">Scope: ${scope || 'n/a'}</span>
            <span class="pill">Confidence: <span class="${badgeClass(entry.confidence)}">${entry.confidence || 'low'}</span></span>
          </div>
          <h4 style="margin:.7rem 0 .45rem;">Research Note (Inline)</h4>
          <pre><code>${escapedDoc}</code></pre>
          <p><a class="btn btn-secondary" href="${entry.repo_url}" target="_blank" rel="noopener noreferrer">Open On GitHub (Optional)</a></p>
          <details><summary>Sources</summary><ul>${sources}</ul></details>
        `;
        return card;
      };

      const renderPrompt = (p) => {
        const card = document.createElement('article');
        card.className = 'card';
        const escaped = String(p.text || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        card.innerHTML = `
          <h3>${p.title}</h3>
          <p><strong>ID:</strong> ${p.id}</p>
          <pre><code>${escaped}</code></pre>
        `;
        return card;
      };

      const loadDocs = fetch('./assets/research/docs.json')
        .then((r) => {
          if (!r.ok) throw new Error('Failed to load inline research docs');
          return r.json();
        })
        .then((data) => {
          const docs = Array.isArray(data.docs) ? data.docs : [];
          docs.forEach((d) => {
            if (d && d.id) docsById.set(d.id, d.content || '');
          });
        })
        .catch(() => {
          // Keep page usable even if inline docs fail; cards will show fallback text.
        });

      fetch('./assets/research/prompts.json')
        .then((r) => {
          if (!r.ok) throw new Error('Failed to load prompt pack');
          return r.json();
        })
        .then((data) => {
          promptsUpdatedEl.textContent = `Prompt pack updated: ${data.updated_at || 'unknown'}`;
          const prompts = Array.isArray(data.prompts) ? data.prompts : [];
          if (prompts.length === 0) {
            promptListEl.innerHTML = '<article class="card"><h3>No prompts yet</h3></article>';
            return;
          }
          prompts.forEach((p) => promptListEl.appendChild(renderPrompt(p)));
        })
        .catch((err) => {
          promptsUpdatedEl.textContent = 'Failed to load prompt pack.';
          promptListEl.innerHTML = `<article class="card"><h3>Load error</h3><p>${err.message}</p></article>`;
        });

      loadDocs.then(() => fetch('./assets/research/index.json'))
        .then((r) => {
          if (!r.ok) throw new Error('Failed to load research index');
          return r.json();
        })
        .then((data) => {
          updatedEl.textContent = `Research index updated: ${data.updated_at || 'unknown'}`;
          const entries = Array.isArray(data.entries) ? data.entries : [];
          if (entries.length === 0) {
            listEl.innerHTML = '<article class="card"><h3>No entries yet</h3></article>';
            return;
          }
          entries.forEach((entry) => listEl.appendChild(renderEntry(entry)));
        })
        .catch((err) => {
          updatedEl.textContent = 'Failed to load research index.';
          listEl.innerHTML = `<article class="card"><h3>Load error</h3><p>${err.message}</p></article>`;
        });
    </script>
  </body>
</html>
