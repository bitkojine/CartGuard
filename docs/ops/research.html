<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#fff7fb" />
    <title>CartGuard Research | Fact-Checked Database</title>
    <meta name="description" content="CartGuard research database with confidence scores, sources, and copy-ready Perplexity prompts." />
    <link rel="icon" type="image/svg+xml" href="/CartGuard/assets/logo-mark.svg?v=7" />
    <link rel="alternate icon" href="/CartGuard/assets/favicon.ico?v=7" sizes="any" />
    <link rel="apple-touch-icon" sizes="180x180" href="/CartGuard/assets/apple-touch-icon.png?v=7" />
    <link rel="manifest" href="/CartGuard/site.webmanifest?v=7" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
    <link rel="stylesheet" href="/CartGuard/styles.css" />
  </head>
  <body class="ops-theme">
    <header class="hero page-hero">
      <nav class="top-nav" aria-label="Primary">
        <a href="/CartGuard/ops/" class="nav-brand"><img src="/CartGuard/assets/logo-mark.svg" alt="CartGuard" class="nav-mark" /><span>CartGuard</span></a>
        <div class="nav-links">
          <a href="/CartGuard/ops/">Home</a>
          <a href="/CartGuard/ops/beachhead.html">Beachhead</a>
          <a href="/CartGuard/ops/paid-pilots.html">Paid Pilots</a>
          <a href="/CartGuard/ops/research.html" aria-current="page">Research</a>
          <a href="/CartGuard/ops/technical.html">Engineering</a>
          <a href="/CartGuard/ops/careers.html">Careers</a>
          <a href="/CartGuard/sales/">Sales Site</a>
                  <button type="button" class="nav-refresh-btn" id="css-hard-refresh">Refresh CSS</button>
        </div>
      </nav>            <section class="warning-banner" aria-label="Brutal priority warning">
        <p class="warning-label">Brutal AI Warning</p>
        <h2>Top priorities and what to do now</h2>
        <ol class="priority-list">
          <li>
            <strong>Priority 1: prove repeatable pilot-to-paid conversion.</strong>
            <ul>
              <li>Run 3 paid pilots with fixed success metrics before start.</li>
              <li>End every pilot with a hard decision: Convert, Extend once, or Stop.</li>
            </ul>
          </li>
          <li>
            <strong>Priority 2: secure budget-owner buy-in early in every pilot.</strong>
            <ul>
              <li>Book budget-owner check-ins in week 1 and at pilot close.</li>
              <li>Track only 3 KPIs: missing-doc rate, review speed, and rework loops.</li>
            </ul>
          </li>
        </ol>
      </section>
      <p class="eyebrow">Research Database</p>
      <h1>Source-backed facts, confidence scores, clear limits.</h1>
      <p class="lead">Everything we claim should map to these entries. If we cannot source it, we do not say it.</p>
      <p class="small-note"><strong>Draft / working notes:</strong> this ops page is in progress and will change as we validate with customers and stronger data.</p>
    </header>

    <main>
      <section class="pricing" aria-label="Research standards">
        <h2>Research Standards</h2>
        <ul>
          <li>Primary sources first (EU institutions, regulators, official statistics).</li>
          <li>Each entry must include date, geography, confidence, and source links.</li>
          <li>Modeled estimates must be labeled as modeled.</li>
          <li>Recommendations only. No legal determinations.</li>
        </ul>
      </section>

      <section class="pricing" aria-label="Open validation questions">
        <h2>Open Questions To Validate</h2>
        <ul>
          <li>Can we prove customers pay for this as a product, not consulting support?</li>
          <li>Can we get repeatable trial-to-contract conversion above 30%?</li>
          <li>Which checks drive real launch-speed outcomes vs compliance theater?</li>
          <li>What evidence would invalidate our current initial market segment?</li>
        </ul>
      </section>

      <section class="architecture" aria-label="Perplexity prompts">
        <h2>Perplexity Prompt Pack (Copy As-Is)</h2>
        <p class="small-note" id="prompts-updated">Loading prompt pack...</p>
        <div id="prompt-list" class="grid" aria-live="polite"></div>
      </section>

      <section class="architecture" aria-label="Fact database">
        <h2>Fact Database</h2>
        <p class="small-note" id="facts-updated">Loading fact database...</p>
        <div class="table-wrap">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Geography</th>
                <th>Claim</th>
                <th>Confidence</th>
                <th>Modeled</th>
                <th>Source</th>
                <th>Entry Link</th>
              </tr>
            </thead>
            <tbody id="facts-table-body"></tbody>
          </table>
        </div>
      </section>

      <section class="architecture" aria-label="Research entries">
        <h2>Research Entries</h2>
        <p class="small-note" id="research-updated">Loading research index...</p>
        <div id="research-list" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <footer>
      <p>CartGuard â€¢ Fact-checked research database</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <script>
      const DATA_ROOT = '/CartGuard/assets/research';
      const listEl = document.getElementById('research-list');
      const updatedEl = document.getElementById('research-updated');
      const promptListEl = document.getElementById('prompt-list');
      const promptsUpdatedEl = document.getElementById('prompts-updated');
      const factsUpdatedEl = document.getElementById('facts-updated');
      const factsTableBodyEl = document.getElementById('facts-table-body');
      const docsById = new Map();

      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      const friendlyError = (message, detail) => {
        const safeDetail = escapeHtml(detail || 'Unknown error');
        return `
          <article class="card">
            <h3>${escapeHtml(message)}</h3>
            <p>${safeDetail}</p>
            <p>To add first entries, create JSON rows in <code>docs/assets/research/facts.json</code>, <code>docs/assets/research/index.json</code>, and <code>docs/assets/research/prompts.json</code>.</p>
          </article>
        `;
      };

      const fetchJson = async (path, label) => {
        let response;
        try {
          response = await fetch(path, { cache: 'no-store' });
        } catch (error) {
          throw new Error(`${label} network error: ${error && error.message ? error.message : 'request failed'}`);
        }
        if (!response.ok) {
          throw new Error(`${label} unavailable (${response.status}) at ${path}`);
        }
        try {
          return await response.json();
        } catch (error) {
          throw new Error(`${label} parse error: ${error && error.message ? error.message : 'invalid JSON'}`);
        }
      };

      const badgeClass = (confidence) => {
        const c = String(confidence || '').toLowerCase();
        if (c === 'high') return 'status yes';
        if (c === 'medium') return 'status partial';
        return 'status no';
      };

      const renderEntry = (entry) => {
        const card = document.createElement('article');
        card.className = 'card';
        const geo = (entry.geography || []).join(', ');
        const scope = (entry.industry_scope || []).join(', ');
        const inlineDoc = docsById.get(entry.id) || 'No inline document text found for this entry.';
        const sources = Array.isArray(entry.sources)
          ? entry.sources.map((url) => `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></li>`).join('')
          : '';
        const escapedDoc = escapeHtml(inlineDoc);
        const entryAnchor = `entry-${entry.id}`;
        card.id = entryAnchor;
        card.innerHTML = `
          <h3>${entry.title}</h3>
          <p>${entry.summary || ''}</p>
          <div class="pill-row">
            <span class="pill">Status: ${entry.status || 'unknown'}</span>
            <span class="pill">Owner: ${entry.owner || 'n/a'}</span>
            <span class="pill">Created: ${entry.created_at || 'n/a'}</span>
            <span class="pill">Verified: ${entry.last_verified_at || 'n/a'}</span>
            <span class="pill">Sources: ${entry.source_count || 0}</span>
            <span class="pill">Geo: ${geo || 'n/a'}</span>
            <span class="pill">Scope: ${scope || 'n/a'}</span>
            <span class="pill">Confidence: <span class="${badgeClass(entry.confidence)}">${entry.confidence || 'low'}</span></span>
          </div>
          <h4 style="margin:.7rem 0 .45rem;">Research Note (Inline)</h4>
          <pre><code class="language-markdown">${escapedDoc}</code></pre>
          <p><a class="btn btn-secondary" href="${entry.repo_url}" target="_blank" rel="noopener noreferrer">Open On GitHub (Optional)</a></p>
          <details><summary>Sources</summary><ul>${sources}</ul></details>
        `;
        if (window.Prism) {
          card.querySelectorAll("code").forEach((node) => window.Prism.highlightElement(node));
        }
        return card;
      };

      const renderPrompt = (p) => {
        const card = document.createElement('article');
        card.className = 'card';
        const escaped = escapeHtml(p.text || '');
        card.innerHTML = `
          <h3>${p.title}</h3>
          <p><strong>ID:</strong> ${p.id}</p>
          <pre><code class="language-markdown">${escaped}</code></pre>
        `;
        if (window.Prism) {
          card.querySelectorAll("code").forEach((node) => window.Prism.highlightElement(node));
        }
        return card;
      };

      const renderFactRow = (fact) => {
        const row = document.createElement('tr');
        const entryHref = `#entry-${fact.research_entry_id}`;
        row.innerHTML = `
          <td>${escapeHtml(fact.date || 'n/a')}</td>
          <td>${escapeHtml(fact.geography || 'n/a')}</td>
          <td>${escapeHtml(fact.claim || 'n/a')}</td>
          <td><span class="${badgeClass(fact.confidence)}">${escapeHtml(fact.confidence || 'low')}</span></td>
          <td>${fact.is_modeled ? 'Yes' : 'No'}</td>
          <td><a href="${escapeHtml(fact.source_url || '#')}" target="_blank" rel="noopener noreferrer">Open source</a></td>
          <td><a href="${entryHref}">Open entry</a></td>
        `;
        return row;
      };

      const loadDocs = fetchJson(`${DATA_ROOT}/docs.json`, 'Inline research docs')
        .then((data) => {
          const docs = Array.isArray(data.docs) ? data.docs : [];
          docs.forEach((d) => {
            if (d && d.id) docsById.set(d.id, d.content || '');
          });
        })
        .catch(() => {
        });

      fetchJson(`${DATA_ROOT}/prompts.json`, 'Prompt pack')
        .then((data) => {
          promptsUpdatedEl.textContent = `Prompt pack updated: ${data.updated_at || 'unknown'}`;
          const prompts = Array.isArray(data.prompts) ? data.prompts : [];
          if (prompts.length === 0) {
            promptListEl.innerHTML = friendlyError('No prompts yet', 'Add the first prompt objects in docs/assets/research/prompts.json.');
            return;
          }
          prompts.forEach((p) => promptListEl.appendChild(renderPrompt(p)));
        })
        .catch((err) => {
          promptsUpdatedEl.textContent = 'Failed to load prompt pack.';
          promptListEl.innerHTML = friendlyError('Prompt pack load failed', err.message);
        });

      fetchJson(`${DATA_ROOT}/facts.json`, 'Fact database')
        .then((data) => {
          factsUpdatedEl.textContent = `Fact database updated: ${data.updated_at || 'unknown'}`;
          const facts = Array.isArray(data.facts) ? data.facts : [];
          if (facts.length === 0) {
            factsTableBodyEl.innerHTML = '<tr><td colspan="7">No facts yet. Add entries to docs/assets/research/facts.json.</td></tr>';
            return;
          }
          facts.forEach((fact) => factsTableBodyEl.appendChild(renderFactRow(fact)));
        })
        .catch((err) => {
          factsUpdatedEl.textContent = 'Failed to load fact database.';
          factsTableBodyEl.innerHTML = `<tr><td colspan="7">${escapeHtml(err.message)}</td></tr>`;
        });

      loadDocs.then(() => fetchJson(`${DATA_ROOT}/index.json`, 'Research index'))
        .then((data) => {
          updatedEl.textContent = `Research index updated: ${data.updated_at || 'unknown'}`;
          const entries = Array.isArray(data.entries) ? data.entries : [];
          if (entries.length === 0) {
            listEl.innerHTML = friendlyError('No entries yet', 'Add the first entry to docs/assets/research/index.json and docs/assets/research/docs.json.');
            return;
          }
          entries.forEach((entry) => listEl.appendChild(renderEntry(entry)));
        })
        .catch((err) => {
          updatedEl.textContent = 'Failed to load research index.';
          listEl.innerHTML = friendlyError('Research index load failed', err.message);
        });
    </script>
    <script id="data-mobile-table-labels">
    (() => {
      const tables = document.querySelectorAll(".comparison-table");
      tables.forEach((table) => {
        const headers = Array.from(table.querySelectorAll("thead th")).map((th) => th.textContent?.trim() || "Field");
        table.querySelectorAll("tbody tr").forEach((row) => {
          Array.from(row.children).forEach((cell, index) => {
            if (cell instanceof HTMLElement) {
              cell.setAttribute("data-label", headers[index] || headers[0] || "Field");
            }
          });
        });
      });
    })();
  </script>
  <script id="css-refresh-script">
    (() => {
      const applyStampToStylesheets = (stamp) => {
        const links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach((node) => {
          if (!(node instanceof HTMLLinkElement)) {
            return;
          }
          const url = new URL(node.href, window.location.href);
          url.searchParams.set("css_refresh", stamp);
          node.href = url.toString();
        });
      };

      const pageUrl = new URL(window.location.href);
      const urlStamp = pageUrl.searchParams.get("css_refresh");
      const storedStamp = window.sessionStorage.getItem("cartguard_css_refresh");
      if (urlStamp) {
        applyStampToStylesheets(urlStamp);
      } else if (storedStamp) {
        applyStampToStylesheets(storedStamp);
      }

      const button = document.getElementById("css-hard-refresh");
      if (!(button instanceof HTMLButtonElement)) {
        return;
      }

      const refreshCss = () => {
        const stamp = Date.now().toString();
        window.sessionStorage.setItem("cartguard_css_refresh", stamp);
        applyStampToStylesheets(stamp);
        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set("css_refresh", stamp);
        window.location.replace(nextUrl.toString());
      };

      button.addEventListener("click", refreshCss);
    })();
  </script>
</body>
</html>
